name: ArgoCD Dependabot
on:
  push:
    branches: [ main ]
  schedule:
    - cron: "0 10 ? * 1" # every monday, 10 am

jobs:
  check:
    name: Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v1.5.2

      - name: Get latest release
        uses: pozetroninc/github-action-get-latest-release@v0.5.0
        id: latest
        with:
          owner: argoproj
          repo: argo-cd
          excludes: prerelease,draft

      - name: Get current version
        id: current
        run: |
          echo "::set-output name=version::$(sed -n 's!.*/argo-cd/\(v[^/]*\)/.*!\1!p' source/kustomization.yaml | head -n1)"

      - name: Update version to latest
        run: |
          sed -i 's!\(/argo-cd/\)v[^/]*!\1${{ steps.latest.outputs.release }}!' source/kustomization.yaml

      - name: Render install.yaml
        run: |
          kustomize build source/ > install.yaml

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v3.4.1
        with:
          title: Bump argoproj/argo-cd from ${{ steps.current.outputs.version }} to ${{ steps.latest.outputs.release }}
          commit-message: Bump argoproj/argo-cd from ${{ steps.current.outputs.version }} to ${{ steps.latest.outputs.release }}
          branch: dependabot/kustomize/argocd
          delete-branch: true
          labels: dependencies,kustomize
